<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlashBring ‚Äî Tech</title>
<!-- ajoute √ßa comme dans cart.html -->
  <script src="/utils/api.js"></script>
  <script src="/js/cart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<style>
:root{
      --bg:#ffffff;
      --ink:#0f0f0f;
      --muted:#6b6b6b;
      --line:#eaeaea;
      --card:#fafafa;   
      --brand:#111111;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.06);
    } 
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
  
 /* Header */
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.8);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:16px;height:68px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand-badge{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:#111;color:#fff}
    .tagline{display:none;color:var(--muted)}
    .actions{display:flex;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ink);padding:10px 14px;border-radius:12px;background:#111;color:#fff;font-weight:600;cursor:pointer}
    .btn.ghost{background:#fff;color:#111}
    .btn:active{transform:translateY(1px)}

/* ‚úÖ Sidebar (Filtres) */
.sidebar {
  position: fixed;
  top: 0;
  right: -100%;
  width: 100%;
  max-width: 360px; /* un peu plus large */
  height: 100vh;
  background: #fff;
  display: flex;
  flex-direction: column;
  border-top-left-radius: 16px;
  border-bottom-left-radius: 16px;
  box-shadow: -6px 0 25px rgba(0, 0, 0, 0.15);
  transition: right 0.35s cubic-bezier(0.25, 1, 0.5, 1);
  z-index: 200;
}
.sidebar.open {
  right: 0;
}

/* ‚úÖ Overlay gris */
.sidebar-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.45);
  z-index: 150;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.sidebar-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* ‚úÖ Header */
.sidebar-header {
  padding: 18px 20px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fafafa;
  border-top-left-radius: 16px;
}
.sidebar-header h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}
.close-btn {
  cursor: pointer;
  font-size: 20px;
  color: #666;
  transition: color 0.2s;
}
.close-btn:hover {
  color: #000;
}

/* ‚úÖ Contenu scrollable */
.sidebar-content {
  flex: 1;
  padding: 18px 20px;
  overflow-y: auto;
}
.sidebar-content h4 {
  font-size: 15px;
  font-weight: 600;
  margin: 0 0 10px;
  color: #333;
}
.sidebar-content label {
  margin-left: 6px;
  font-size: 14px;
  color: #444;
}

/* ‚úÖ Footer avec boutons */
.sidebar-footer {
  padding: 14px 20px;
  border-top: 1px solid #eee;
  background: #fafafa;
  display: flex;
  gap: 10px;
}
.sidebar-footer button {
  flex: 1;
  padding: 12px;
  font-size: 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}
.sidebar-footer button.reset {
  background: #f5f5f5;
  color: #555;
}
.sidebar-footer button.reset:hover {
  background: #eaeaea;
}
.sidebar-footer button.apply {
  background: #007bff;
  color: white;
}
.sidebar-footer button.apply:hover {
  background: #006ae6;
}



.view .page {
  max-width: 900px;
  margin: 0 auto;      /* centre horizontalement */
  padding: 24px 16px;  /* espace int√©rieur agr√©able */
  box-sizing: border-box;
}



/* Cat√©gories food */ 
.categories {
  display: flex;
  justify-content: space-between;   
  flex-wrap: nowrap;
  gap: 20px;
  margin: 20px 0;
}
  
.cat-item {
  flex: 1;
  text-align: center;
  cursor: pointer;  
  font-size: 24px;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: background 0.2s;
  padding: 10px;
  border-radius: 10px;
}

.cat-item span {
  font-size: 14px;
  margin-top: 5px;
}
 
.cat-item.active {
  background: #f2f2f2;
}
  
  
  



.card {
  flex: 0 0 calc(25% - 12px); /* 4 cartes visibles max */
  box-sizing: border-box;
}

.card img {
  width: 100%;
  height: 150px;      /* tu fixes la hauteur que tu veux */
  object-fit: cover;  /* √©vite la d√©formation */
  border-radius: 16px; /* ‚úÖ arrondit les bords de l‚Äôimage */
}

.card-info {
  padding: 8px 0;       /* juste un petit espace entre image et texte */
}

.card-info h3 {
  margin: 4px 0;
  font-size: 18px;
  font-weight: 600;
}

.card-meta {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  color: #666;
  margin-top: 4px;
}
  .card-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .card-meta .rating {
    color: #ffb400; /* jaune √©toiles */
  }

.card-info p {
  margin: 2px 0;  /* r√©duit l‚Äôespace vertical */
  font-size: 14px;
  color: #444;
}

.carousel {
  width: 100%;
  overflow: hidden;
}
.carousel-track {
  display: flex;
  gap: 16px;
  transition: transform 0.3s ease;
}
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.carousel-controls button {
  border: none;
  background: transparent; /* plus de fond noir */
  color: #000;             /* couleur noire pour la fl√®che */
  font-size: 28px;         /* taille de la fl√®che */
  cursor: pointer;
  padding: 0;              /* supprime le padding inutile */
  line-height: 1;
}

.carousel-controls button:hover {
  color: #555; /* l√©ger changement au survol */
}

.badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background: red;
  color: white;
  font-size: 0.8rem;
  font-weight: bold;
  padding: 4px 6px;
  border-radius: 6px;
}

.btn.gray {
  background: #f2f2f2;
  color: #111;
  border: 1px solid #ddd;
}
.btn.gray:active {
  transform: translateY(1px);
}

/* --- Style global des checkboxes stylis√©es --- */
input[type="checkbox"] {
  display: none; /* on cache la case */
}

input[type="checkbox"] + label {
  display: inline-flex;
  align-items: center;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 8px 16px;
  margin: 4px 6px 4px 0;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: #333;
  transition: all 0.25s ease;
  user-select: none;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

input[type="checkbox"] + label:hover {
  background: #f1f1f1;
  border-color: #bbb;
}

input[type="checkbox"]:checked + label {
  background: #111;
  color: #fff;
  border-color: #111;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transform: translateY(-1px); /* petit effet press√© */
}


/* --- Variante pour Distance (chips arrondies) --- */
input[type="checkbox"] + label.distance-option {
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 13px;
  background: #fff;
  border: 1px solid #aaa;
  color: #444;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

input[type="checkbox"] + label.distance-option:hover {
  background: #f6f6f6;
  border-color: #888;
}

input[type="checkbox"]:checked + label.distance-option {
  background: #000;
  color: #fff;
  border-color: #000;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* --- Frais de livraison (style pastilles ‚Ç¨ bleues) --- */
input[type="checkbox"] + label.fee-option {
  border-radius: 50px;
  background: #fff;
  border: 1.5px solid #1976d2;
  padding: 8px 16px 8px 32px;
  font-size: 14px;
  font-weight: 500;
  position: relative; 
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
input[type="checkbox"] + label.fee-option::before {
  content: "‚Ç¨";
  position: absolute;
  left: 12px; 
  color: #1976d2;
  font-weight: 600;
}
input[type="checkbox"] + label.fee-option:hover {
  background: #f6faff;
}
input[type="checkbox"]:checked + label.fee-option {
  background: #e3f2fd;
  color: #1976d2;
  border-color: #1565c0;
  font-weight: 600;  
  box-shadow: 0 2px 6px rgba(25, 118, 210, 0.25);
  transform: translateY(-1px);
}
/* Cache les checkbox / radios natifs */
input[type="checkbox"],
input[type="radio"] {
  display: none;
}
/* --- Trier options --- */
.sort-option {
  display: block;
  padding: 12px 14px;
  margin: 6px 0;
  border: 1px solid #ddd;
  border-radius: 10px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 500;
  transition: all 0.25s ease;
}
.sort-option:hover {
  background: #f9f9f9;
}
input[name="sort"]:checked + label {
  background: #2563eb; /* bleu moderne */
  color: #fff;
  border-color: #2563eb;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(37,99,235,0.3);
}
/* --- Boutons filtres (bas du sidecart) --- */
.filters-actions {
  display: flex;   
  justify-content: space-between;
  gap: 12px;
  margin-top: 24px;  
}
.filters-actions button {
  flex: 1;
  padding: 12px 18px;  
  font-size: 15px;   
  font-weight: 600;
  border-radius: 12px;
  cursor: pointer;  
  transition: all 0.25s ease;
}

/* R√©initialiser */
#resetFilters { 
  background: #fafafa;
  color: #333;
  border: 1px solid #ddd;
}
#resetFilters:hover {
  background: #f0f0f0;  
  border-color: #ccc;
}
/* Appliquer */
#applyFilters {   
  background: linear-gradient(135deg, #111, #333);
  color: #fff;
  border: none;
  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
}
#applyFilters:hover {
  background: linear-gradient(135deg, #000, #222);
  transform: translateY(-1px);
}

/* --- Bouton Filtrer (premium) --- */
#openFilters {
  background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 12px 22px;
  font-size: 15px;
  font-weight: 600;
  letter-spacing: 0.3px;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.18);
}

#openFilters:hover {
  background: linear-gradient(135deg, #000, #1a1a1a);
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.28);
}

#openFilters:active {
  transform: translateY(0) scale(0.98);
  background: linear-gradient(135deg, #111, #222);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25) inset;
}



html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}
  
body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

main {
  flex: 1;
}
  
/* Footer */
footer {
  border-top: 1px solid #ddd; /* fine ligne de s√©paration */
  padding: 30px 0;
  color: #666;
  font-size: 14px; 
  background: #fff;
 position: relative; 
} 

footer .container {
  max-width: 1200px;  /* m√™me largeur que la banni√®re et le contenu */
  margin: 0 auto;     /* centre le bloc */
  padding: 0 20px;    /* petit padding horizontal */
}
  
.fcols {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr;
  gap: 30px;
}
  
.fcols a{
display:block;
color:var(--muted);
margin: 10px 0;
text-decoration: none;
} 

.copy { 
  margin-top: 15px;
  font-size: 13px;
  color: #999;
}
footer .brand b {  
  font-size: 18px;  
  color: #000; /* ou la couleur de ton choix */
} 
footer .brand + div {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
} 
.footer-support {
  position: absolute;
  bottom: 10px;   /* colle en bas */
  right: 20px;    /* colle √† droite */
  text-align: right;
  font-size: 14px;
  color: #000;
}
.badges-wrapper {
  position: absolute;
  top: 8px;
  left: 8px;
  display: flex;
  gap: 6px;
  flex-wrap: nowrap;  /* ‚úÖ m√™me ligne */
}

.badge {
  position: relative;   /* ‚ö†Ô∏è plus de absolute */
  padding: 4px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;  /* ‚úÖ √©vite le retour √† la ligne */
}
.badge-horszone { background: #e53935; }      /* rouge */
.badge-partenaire { background: #0070f3; }   /* bleu */
.badge-nouveau { background: #00b341; }      /* vert */
.badge-top { background: #ff9800; }          /* orange */

/* --- Barre de recherche --- */
.search-bar {
  display: flex;   
  gap: 10px;
  margin-bottom: 20px;
}
 
.search-bar input {
  flex: 1;
  padding: 10px 15px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  outline: none;
  box-shadow: 0 0 0 1px #eee; /* üëâ c'est √ßa qui fait la ligne grise */
}

.search-bar button {  
  background: #ff6b00;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 10px 20px;
  font-size: 16px; 
  cursor: pointer; 
  transition: 0.2s;
}
.search-bar button:hover {
  background: #e55a00;
}
.suggestions-box {
  background: #fff;      
  border: none; 
  border-radius: 8px;
  max-height: 200px;
  overflow-y: auto;
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;  
  z-index: 1000;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15); /* ‚úÖ plus moderne */
}
.suggestions-box div {
  padding: 8px 12px;
  cursor: pointer;
}
.suggestions-box div:hover {
  background: #f5f5f5;
}
.suggestions-box div {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  cursor: pointer;
  border-bottom: 1px solid #eee; /* ‚úÖ s√©parateur */
}

.suggestions-box div:last-child {
  border-bottom: none; /* pas de ligne apr√®s la derni√®re */
}

.suggestions-box img {
  width: 24px;
  height: 24px;
  border-radius: 6px;
  object-fit: cover;
}

.suggestions-box .icon {
  width: 20px;
  height: 20px;
  opacity: 0.6;
}
/* Bouton croix minimaliste */
.clear-btn {
  all: unset;                /* ‚úÖ reset tous les styles h√©rit√©s */
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  color: #000;
  cursor: pointer;
  line-height: 1;
}
.clear-btn:hover {
  color: #666;  /* l√©ger changement au survol */
}
/* Force le bouton croix √† √™tre minimaliste */
#clearSearch {
  all: unset;              /* reset tous les styles par d√©faut */
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  color: #888;             /* gris neutre */
  cursor: pointer;
  line-height: 1;
}
.store-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.heart {
  cursor: pointer;
  font-size: 20px;
  color: gray;
  margin-left: 8px;
  transition: color 0.2s;
}
.heart.active {
  color: black; /* c≈ìur noir quand favori */
}

/* === Popup infos (version pro) === */
#infoPopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  width: 92%;
  max-width: 420px;
  max-height: 85vh;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 12px 36px rgba(0,0,0,.25);
  z-index: 300;   
  overflow-y: auto;
  opacity: 0;
  transition: all 0.25s ease;
}
    
#infoPopup.open {
  display: block;
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}
   
/* Overlay pro */
#infoOverlay {
  display: none;
  position: fixed;
  inset: 0; 
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(3px);
  z-index: 250;
  opacity: 0;
  transition: opacity 0.25s ease;
}
#infoOverlay.active {
  display: block;  
  opacity: 1;
}
  
/* Header popup */
#infoPopup .sidebar-header {
  padding: 18px 20px;
  border-bottom: 1px solid #eee;
  font-weight: 600;
  font-size: 17px;
  background: #fafafa;
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
}
/* Contenu popup */
#infoPopup .sidebar-content {
  padding: 20px;
  font-size: 15px;
  color: #333;
  line-height: 1.6;
}
#infoPopup strong {
  color: #111; 
}
  
/* Bouton i modernis√© */
.info-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 26px;
  height: 26px;   
  border-radius: 50%;
  border: 1px solid #ccc;
  background: #fff;
  color: #333;
  font-size: 14px;
  font-weight: bold;  
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.info-btn:hover {  
  background: #111;
  color: #fff;  
  border-color: #111;
}
  
/* Bouton fermer ‚úï */
#closeInfo {
  cursor: pointer;
  font-size: 18px;
  color: #666;
  transition: color 0.2s ease;
}
#closeInfo:hover {
  color: #000;
}
.filters-bar {
  display: flex;
  justify-content: space-between; /* Filtrer √† gauche, i √† droite */
  align-items: center;
  margin-bottom: 16px; /* petit espace dessous */
}



</style>
</head>
<body>
<script>
async function checkAuth() {
  try {
    const res = await fetch("/api/users/me", { credentials: "include" });
    if (!res.ok) throw new Error("Not connected");
    return await res.json(); // ‚úÖ user connect√©
  } catch (err) {
    // ‚ùå Pas connect√© ‚Üí redirige vers la home avec un param√®tre
    window.location.href = "/index.html?openAuth=1";
  }
}
  
// ‚úÖ bloque d√®s le d√©but si pas connect√©
document.addEventListener("DOMContentLoaded", async () => {
  await checkAuth();
});
</script>

<main>
<div class="page-container">
<!-- Header -->
<header>
  <div class="container nav">
      <a class="brand" href="https://localhost:3000">
      <div class="brand-badge">‚ö°Ô∏è</div>
      <div>  
        <div style="font-size:18px;letter-spacing:-.3px">FlashBring</div>
        <div class="tagline">Tout, livr√© en 2h</div>
      </div>
    </a>
<div class="actions">
<div id="userMenu" style="display:none; position:relative; align-items:center; gap:12px;">
    <span id="welcomeMsg" style="cursor:pointer;font-weight:600;font-size:15px;">
      Bonjour <span id="welcomeName"></span>
    </span>
  </div>
</div>
  
<!-- Overlay gris derri√®re le side cart -->
<div id="sidebarOverlay" class="sidebar-overlay"></div>  
<!-- üëâ Le vrai conteneur du side cart -->
<div id="userSidebar" class="sidebar">
<div class="sidebar-user">
  <div id="sidebarName">
    Bonjour
  </div>
<a href="account.html" class="manage-account">G√©rer le compte</a>
</div>
<ul class="sidebar-links">
  <li><a href="/#orders">Mes commandes</a></li>
  <li><a href="cart.html">Mon panier</a></li>
  <li><a href="/#favorites">Favoris</a></li>
  <li><a href="/#refer">Parrainer</a></li>
  <li><a href="/#help">Aide</a></li>
  <li><a href="/#settings">Param√®tres</a></li>
  <li><a href="#" id="logoutBtn">Se d√©connecter</a></li>
    
  <!-- s√©parateur -->
  <li style="border-top:2px solid #eee; margin:10px 0"></li>
    
  <li><a href="/#partners">Ajouter votre restaurant</a></li>
  <li><a href="/#drivers">Inscrivez-vous pour livrer</a></li>
</ul>   

  
</div> <!-- ferme .sidebar -->
</div>
  </header>

<!-- PAGE RESTAURANTS -->
<section class="view">
  <div class="page">
  
<!-- Barre de recherche -->
<div class="search-bar" style="position: relative;">
  <input type="text" id="restaurantSearch" placeholder="Quel produit tech cherchez-vous ?">
<button id="clearSearch" class="clear-btn">‚úï</button>
  <div id="suggestions" class="suggestions-box"></div>
</div>

<!-- Cat√©gories Tech -->
<div class="categories">
  <div class="cat-item" data-cat="smartphones">üì±<span>Smartphones</span></div>
  <div class="cat-item" data-cat="pc">üíª<span>PC</span></div>
  <div class="cat-item" data-cat="consoles">üéÆ<span>Consoles</span></div>
  <div class="cat-item" data-cat="jeux">üïπÔ∏è<span>Jeux</span></div>
  <div class="cat-item" data-cat="audio">üéß<span>Audio</span></div>
  <div class="cat-item" data-cat="enceintes">üéµ<span>Enceintes</span></div>
  <div class="cat-item" data-cat="montres">‚åö<span>Montres</span></div>
  <div class="cat-item" data-cat="photo">üì∑<span>Photo</span></div>
  <div class="cat-item" data-cat="accessoires">üîå<span>Accessoires</span></div>
</div>

    
<!-- Apr√®s -->
<!-- Regroupe Filtrer + Info dans une barre -->
<div class="filters-bar">
  <button id="openFilters" class="btn gray">Filtrer</button>
  <button id="openInfo" class="info-btn">i</button>    
</div>



<!-- Overlay -->
<div id="filtersOverlay" class="sidebar-overlay"></div>

<!-- Sidecart Filtres -->
<div id="filtersSidebar" class="sidebar">
  <div class="sidebar-header">
    <h3 style="margin:0;">Tous les filtres</h3>
    <span id="closeFilters" class="close-btn">‚úï</span>
  </div>
  <div class="sidebar-content" style="padding:16px; overflow-y:auto;">

<div style="margin-bottom:20px;">
  <h4 style="margin:0 0 10px 0;">√âtat du produit</h4>
  
  <input type="checkbox" id="etat-neuf" name="etat" value="neuf">
  <label for="etat-neuf">Neuf</label>
      
  <input type="checkbox" id="etat-reconditionne" name="etat" value="reconditionn√©">
  <label for="etat-reconditionne">Reconditionn√©</label>
</div>
  
<div style="border-top:1px solid #eee; margin:20px 0;"></div>

<div style="margin-bottom:20px;">
  <h4 style="margin:0 0 10px 0;">Distance</h4>  

  <input type="checkbox" id="dist-500" name="distance" value="0.5">
  <label class="distance-option" for="dist-500">‚â§ 500 m</label>
  
  <input type="checkbox" id="dist-1000" name="distance" value="1">
  <label class="distance-option" for="dist-1000">‚â§ 1 km</label>

  <input type="checkbox" id="dist-plus" name="distance" value="plus">
  <label class="distance-option" for="dist-plus">&gt; 1 km</label>
</div>

<div style="border-top:1px solid #eee; margin:20px 0;"></div>

<div style="margin-bottom:20px;">
  <h4 style="margin:0 0 10px 0;">Frais de livraison</h4>

  <input type="checkbox" id="fee-3-5" name="delivery_fee" value="3.5">
  <label class="fee-option" for="fee-3-5">‚â§ 3,50 ‚Ç¨</label>
  
  <input type="checkbox" id="fee-10" name="delivery_fee" value="10">
  <label class="fee-option" for="fee-10">‚â§ 10 ‚Ç¨</label>

  <input type="checkbox" id="fee-plus" name="delivery_fee" value="plus">
  <label class="fee-option" for="fee-plus">&gt; 10 ‚Ç¨</label>
</div>
  


<div style="border-top:1px solid #eee; margin:20px 0;"></div>

<div style="margin-bottom:20px;">
  <h4 style="margin:0 0 10px 0;">Trier par</h4>


  <input type="radio" id="sort-4" name="sort" value="rating4">
  <label class="sort-option" for="sort-4">Note ‚â• 4‚≠ê</label>

  <input type="radio" id="sort-5" name="sort" value="rating5">
  <label class="sort-option" for="sort-5">Note = 5‚≠ê</label>
</div>

<div style="border-top:1px solid #eee; margin:20px 0;"></div>
<div class="filters-actions">
  <button id="resetFilters">R√©initialiser</button>
  <button id="applyFilters">Appliquer</button>
</div>

  </div>
</div>

<!-- R√©sum√© r√©sultats -->
<p id="resultsCount">0 r√©sultat</p>
<!-- Blocs fa√ßon Uber -->
  
<!-- Section Recommand√©e -->
<div class="section" id="recommended-section" style="display:none;">
  <div class="section-header">
    <h2>Recommand√© pour vous</h2>
    <div class="carousel-controls">
      <button class="prev-btn">‚Üê</button>
      <button class="next-btn">‚Üí</button>
    </div>
  </div>
  <div class="carousel">
    <div id="section-recommended" class="carousel-track"></div>
  </div>
</div>

<!-- Vos favoris -->
<div class="section" id="favorites-section" style="display:none;">
  <div class="section-header">
    <h2>Vos enseignes pr√©f√©r√©s</h2>
    <div class="carousel-controls">
      <button class="prev-btn">‚Üê</button>
      <button class="next-btn">‚Üí</button>
    </div>
  </div>
  <div class="carousel">
    <div id="section-favoris" class="carousel-track"></div>
  </div>
</div>

<!-- Les enseignes -->
<div class="section">
  <div class="section-header">
    <h2>Les enseignes</h2>
    <div class="carousel-controls">
      <button class="prev-btn">‚Üê</button>
      <button class="next-btn">‚Üí</button>
    </div>
  </div>
  <div class="carousel">
    <div id="section-enseigne" class="carousel-track"></div>
  </div>
</div>

<!-- Magasins pr√®s de chez vous -->
<div class="section">
  <div class="section-header">
    <h2>Magasins pr√®s de chez vous</h2>
    <div class="carousel-controls">
      <button class="prev-btn">‚Üê</button>
      <button class="next-btn">‚Üí</button>
    </div>
  </div>
  <div class="carousel">
    <div id="section-pres" class="carousel-track"></div>
  </div>
</div>

<!-- Populaire pr√®s de chez vous -->
<div class="section">
  <div class="section-header">
    <h2>Populaire pr√®s de chez vous</h2>
    <div class="carousel-controls">
      <button class="prev-btn">‚Üê</button>
      <button class="next-btn">‚Üí</button>
    </div>
  </div>
  <div class="carousel">
    <div id="section-pop" class="carousel-track"></div>
  </div>
</div>

<!-- Vous √™tes press√© ? -->
<div class="section">
  <div class="section-header">
    <h2>Vous √™tes press√© ?</h2>
    <div class="carousel-controls">
      <button class="prev-btn">‚Üê</button>
      <button class="next-btn">‚Üí</button>
    </div>
  </div>
  <div class="carousel">
    <div id="section-rapide" class="carousel-track"></div>
  </div>
</div>

<!-- Les plus populaires -->
<div class="section">
  <div class="section-header">
    <h2>Les plus populaires</h2>
    <div class="carousel-controls">
      <button class="prev-btn">‚Üê</button>
      <button class="next-btn">‚Üí</button>
    </div>
  </div>
  <div class="carousel">
    <div id="section-populaires" class="carousel-track"></div>
  </div>
</div>

<!-- Tous les magasins -->
<div class="section">
  <div class="section-header">
    <h2>Tous les magasins</h2>
    <div class="carousel-controls">
      <button class="prev-btn">‚Üê</button>
      <button class="next-btn">‚Üí</button>
    </div>
  </div>
  <div class="carousel">
    <div id="section-all" class="carousel-track"></div>
  </div>
</div>


<div id="infoOverlay"></div>
<div id="infoPopup">
  <div class="sidebar-header">
<h3 style="margin:0 0 16px 0; font-size:18px;">Transparence & Informations Importantes</h3>

    <span id="closeInfo" class="close-btn">‚úï</span>
  </div>
<div class="sidebar-content" style="padding:18px;">

  <div style="margin-bottom:14px;">
    <strong>1. Partenaires officiels</strong>
    <ul style="margin:6px 0 0 18px; padding:0; font-size:14px; line-height:1.6;">
      <li>Les enseignes avec le badge <b>Partenaire</b> travaillent directement avec nous.</li>
      <li>Les autres enseignes sont propos√©es pour √©largir votre choix, sans partenariat officiel.</li>
    </ul>
  </div>

  <div style="margin-bottom:14px;">
    <strong>2. Disponibilit√© & pr√©cision des informations</strong>
    <ul style="margin:6px 0 0 18px; padding:0; font-size:14px; line-height:1.6;">
      <li>Nous faisons notre maximum pour que les informations (menus, prix, horaires) soient √† jour.</li>
      <li>Cependant, certaines donn√©es peuvent varier selon les enseignes.</li>
    </ul>
  </div>

  <div style="margin-bottom:14px;">
    <strong>3. Livraison & d√©lais</strong>
    <ul style="margin:6px 0 0 18px; padding:0; font-size:14px; line-height:1.6;">
      <li>Les d√©lais de livraison sont des estimations proche calcul√©es selon la distance.</li>
      <li>Ils peuvent l√©g√®rement varier en fonction des conditions (trafic, m√©t√©o, affluence).</li>
    </ul>
  </div>

  <div style="margin-bottom:14px;">
    <strong>4. Frais de livraison</strong>
    <ul style="margin:6px 0 0 18px; padding:0; font-size:14px; line-height:1.6;">
      <li>Les frais sont calcul√©s automatiquement en fonction de la distance et de la cat√©gorie choisie.</li>
    </ul>
  </div>

  <div style="margin-bottom:14px;">
    <strong>5. Favoris & pr√©f√©rences</strong>
    <ul style="margin:6px 0 0 18px; padding:0; font-size:14px; line-height:1.6;">
      <li>La fonctionnalit√© <b>Favoris</b> vous permet de retrouver rapidement vos enseignes pr√©f√©r√©es.</li>
      <li>Cela n‚Äôinfluence pas les prix ni la disponibilit√© des produits.</li>
    </ul>
  </div>

  <div style="margin-bottom:0;">
    <strong>6. Informations l√©gales</strong>
    <p style="margin:6px 0 0; font-size:14px; line-height:1.6;">
FlashBring est une plateforme qui facilite la livraison de vos produits, similaire √† Uber Eats.
      Certaines enseignes list√©es ne sont pas encore partenaires officiels et sont propos√©es √† titre informatif.  
      Nous travaillons activement √† d√©velopper des partenariats : avec votre soutien, vos enseignes pr√©f√©r√©es pourront rejoindre officiellement notre catalogue.
    </p>
  </div>
</div>
</div>




<script>
document.addEventListener("DOMContentLoaded", async () => {
  console.log("‚úÖ Script cart.js charg√© !");
      
  const welcomeName = document.getElementById("welcomeName"); // header
  const sidebarName = document.getElementById("sidebarName"); // sidecart
  const userMenu = document.getElementById("userMenu");
  const userSidebar = document.getElementById("userSidebar");
  const sidebarOverlay = document.getElementById("sidebarOverlay");
  const logoutBtn = document.getElementById("logoutBtn");
  const welcomeMsg = document.getElementById("welcomeMsg");
  
  const addressEl = document.getElementById("userAddress");
  const cityEl = document.getElementById("userCity");
      
    
    
// --- R√©cup√©rer utilisateur connect√© ---
  try {
    const res = await apiFetch("/api/auth/me");
    console.log("DEBUG /me status:", res.status);
         
    if (res.ok) {
      const user = await res.json();
      console.log("üåê /me data:", user);
    
      const displayName = user.firstname || "Utilisateur";
      if (userMenu) userMenu.style.display = "flex";
      if (welcomeName) welcomeName.textContent = displayName;
      if (sidebarName) sidebarName.textContent = "Bonjour " + displayName;

      if (addressEl) addressEl.textContent = user.street || "Adresse non d√©finie";
      if (cityEl) cityEl.textContent = user.city || "Ville non d√©finie";
    } else {
      console.error("‚ùå /me pas OK:", await res.text());
    }
  } catch (err) {
    console.error("‚ùå Erreur r√©cup√©ration utilisateur:", err);
  }
  
  // --- Sidebar ---
  if (welcomeMsg) {
    welcomeMsg.addEventListener("click", () => {
      userSidebar.classList.add("open");
      sidebarOverlay.classList.add("active");
    });
  }
  if (sidebarOverlay) {
    sidebarOverlay.addEventListener("click", () => {
      userSidebar.classList.remove("open");
      sidebarOverlay.classList.remove("active");
    });
  }
  document.querySelectorAll("#userSidebar a").forEach(link => {
    link.addEventListener("click", () => {
      userSidebar.classList.remove("open");
      sidebarOverlay.classList.remove("active");
    });
  });
// --- D√©connexion ---
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
await apiFetch("/api/auth/logout", { method: "POST" });
        userMenu.style.display = "none";
        if (welcomeName) welcomeName.textContent = "";
        if (sidebarName) sidebarName.textContent = "";
      } catch (err) {
        console.error("‚ùå Erreur d√©connexion:", err);
      }
    });
  }
   
</script>
<script>

</script>
<script>
// --- Calcul distance en km ---
function getDistanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

// --- Affichage d'une liste de stores dans une section ---
function renderStores(stores, containerId, user = null) {
  const container = document.getElementById(containerId);
  if (!container) return;

  if (stores.length === 0) {
    container.innerHTML = `<p>Aucun magasin trouv√©.</p>`;
    return;
  }

  container.innerHTML = stores.map(store => {
    const deliveryFee = store.delivery_fee
      ? `${store.delivery_fee.toFixed(2)} ‚Ç¨`
      : "‚Äî";

    const rating = store.rating || 4.5; // valeur par d√©faut
    const ordersCount = store._count?.orders || 0;

    // ‚úÖ Badge distance (Hors zone)
    let distanceBadge = "";
    if (user?.lat && user?.lng && store.lat && store.lng) {
      const dist = getDistanceKm(user.lat, user.lng, store.lat, store.lng);
      if (dist > 10) {
        distanceBadge = `<span class="badge badge-horszone">Hors zone</span>`;
      }
    }

    // ‚úÖ Badges confiance/credibilit√© (1 seul affich√©)
    let extraBadge = "";
    if (store.badges && store.badges.length > 0) {
      if (store.badges.includes("partenaire")) {
        extraBadge = `<span class="badge badge-partenaire">Partenaire</span>`;
      } else if (store.badges.includes("top")) {
        extraBadge = `<span class="badge badge-top">Top vendeur</span>`;
      } else if (store.badges.includes("nouveau")) {
        extraBadge = `<span class="badge badge-nouveau">Nouveau</span>`;
      }
    }

    // ‚úÖ Temps de livraison estim√©
    const deliveryTime = store.estimated_delivery_time
      ? `${store.estimated_delivery_time - 3}-${store.estimated_delivery_time + 3} min`
      : "‚Äî";

    return `
      <div class="card" onclick="window.location.href='store-tech.html?id=${store.id}'" style="cursor:pointer; position:relative;">
        <div class="badges-wrapper">
          ${distanceBadge}
          ${extraBadge}
        </div>
        <img src="${store.banner_url}" alt="${store.name}">
        <div class="card-info">
          <h3>
            ${store.name}
<span
  class="heart ${store.isFavorite ? "active" : ""}"
  data-store-id="${store.id}"
  onclick="toggleFavorite(event, ${store.id})"
>
  ${store.isFavorite ? "‚ô•" : "‚ô°"}
</span>
          </h3>
          <p>Frais de livraison : ${deliveryFee}</p>
          <p>‚≠ê ${rating} (${ordersCount}+) ¬∑ ${deliveryTime}</p>
        </div>
      </div>
    `;
  }).join("");
}

let fuse; // global

// --- Charger et dispatcher les stores (brut) ---
async function loadStores(lat = null, lng = null, user = null) {
let url = "https://localhost:3000/api/stores?category=tech";
  if (lat && lng) {
    url += `&lat=${lat}&lng=${lng}`;
  }

  // üî• Charger les stores
  const res = await fetch(url, { credentials: "include" });
  const stores = await res.json();

// üî• R√©cup√©rer les favoris en base
let favorites = [];
try {
  const favRes = await fetch("https://localhost:3000/api/favorites", {
    credentials: "include"
  });
  if (favRes.ok) {
    const favData = await favRes.json();
    favorites = favData.favorites || []; // ‚úÖ on r√©cup√®re bien le tableau
  }
} catch (err) {
  console.error("Erreur r√©cup√©ration favoris :", err);
}

console.log("üì¶ Stores :", stores);
console.log("‚ù§Ô∏è Favoris :", favorites);

const favIds = favorites.map(f => f.store_id ?? f.id); // supporte les deux cas (store_id ou id)

// ‚úÖ Ajouter un flag isFavorite
window.stores = stores.map(s => ({
  ...s,
  isFavorite: favIds.includes(s.id)
}));

  window.currentUser = user;

  // üîé Init Fuse avec la liste enrichie
  fuse = new Fuse(window.stores, {
    keys: ["name", "subcategory", "diet_type"],
    threshold: 0.3,
  });

  // affichage initial (pas de filtres)
  applyFilters(user);
}

// --- Appliquer les filtres et mettre √† jour l'affichage ---
function applyFilters(user) {

 // --- √âtat produit (tech) ---
  const selectedEtat = Array.from(
    document.querySelectorAll("input[name='etat']:checked")
  ).map(el => el.value);

 // --- Distance ---
  const distanceInput = document.querySelector("input[name='distance']:checked");
  const selectedDistance = distanceInput ? distanceInput.value : null;

// --- Frais de livraison ---
  const feeInput = document.querySelector("input[name='delivery_fee']:checked");
  const selectedFee = feeInput ? feeInput.value : null;

  // üîé Si une recherche est active, on repart de l√†
  let filteredStores = window.storesFiltered
    ? [...window.storesFiltered]
    : [...window.stores];

 // --- Filtre tech (store_type) ---
  if (selectedEtat.length) {
    filteredStores = filteredStores.filter(s =>
      selectedEtat.includes(s.store_type?.toLowerCase())
    );
  }

  // --- Distance
  if (user?.lat && user?.lng && selectedDistance) {
    filteredStores = filteredStores.filter(s => {
      if (!s.lat || !s.lng) return false;
      const dist = getDistanceKm(user.lat, user.lng, s.lat, s.lng);
      if (selectedDistance === "0.5") return dist <= 0.5;
      if (selectedDistance === "1") return dist <= 1;
      if (selectedDistance === "plus") return dist > 1;
      return true;
    });
  }

// --- Frais de livraison
if (selectedFee) {
  filteredStores = filteredStores.filter(s => {
    const fee = s.delivery_fee || 0;
    if (selectedFee === "3.5") return fee <= 3.5;
    if (selectedFee === "10") return fee > 3.5 && fee <= 10;
    if (selectedFee === "plus") return fee > 10;
    return true;
  });
}

  // --- Trier par
  const sortInput = document.querySelector("input[name='sort']:checked");
  const selectedSort = sortInput ? sortInput.value : null;

  if (selectedSort) {
    if (selectedSort === "rating4") {
      filteredStores = filteredStores.filter(s => (s.rating || 4.5) >= 4);
    } else if (selectedSort === "rating5") {
      filteredStores = filteredStores.filter(s => (s.rating || 4.5) === 5);
    }
  }

// --- üîÆ Recommand√© pour vous ---
const deviceType = detectDevice(); // üëà fonction userAgent (ios, android, pc, console)

const recommendedStores = filteredStores.filter(s =>
  Array.isArray(s.recommended_for) && s.recommended_for.includes(deviceType)
);

const recommendedSection = document.getElementById("recommended-section");
if (recommendedStores.length > 0) {
  recommendedSection.style.display = "block";
  renderStores(recommendedStores, "section-recommended", user);
  setupCarousel("section-recommended");
} else {
  recommendedSection.style.display = "none";
}

 // --- üî• Vos favoris (s'affiche uniquement si favoris > 0)
  const favorisSection = document.getElementById("favorites-section");
  const favorisStores = filteredStores.filter(s => s.isFavorite);

  if (favorisStores.length > 0) {
    favorisSection.style.display = "block";
    renderStores(favorisStores, "section-favoris", user);
    setupCarousel("section-favoris");
  } else {
    favorisSection.style.display = "none";
  }

  // --- Sections ---
  renderStores(filteredStores, "section-enseigne", user);

  if (user?.lat && user?.lng) {
    // Magasins ‚â§ 0.5 km
    let nearby = filteredStores.filter(
      s => getDistanceKm(user.lat, user.lng, s.lat, s.lng) <= 0.5
    );
    renderStores(nearby, "section-pres", user);

    // Populaire pr√®s de chez vous (‚â§ 1 km tri√©s par nb commandes)
    let popularNearby = filteredStores
      .filter(s => getDistanceKm(user.lat, user.lng, s.lat, s.lng) <= 1)
      .sort((a, b) => (b._count?.orders || 0) - (a._count?.orders || 0));
    renderStores(popularNearby, "section-pop", user);
  }

  // "Vous √™tes press√© ?" ‚Üí tri par frais de livraison
  let fastStores = [...filteredStores].sort(
    (a, b) => (a.delivery_fee || 0) - (b.delivery_fee || 0)
  );
  renderStores(fastStores, "section-rapide", user);

  // "Les plus populaires" ‚Üí tri par nb commandes global
  let mostPopular = [...filteredStores].sort(
    (a, b) => (b._count?.orders || 0) - (a._count?.orders || 0)
  );
  renderStores(mostPopular, "section-populaires", user);

  // Tous les magasins
  renderStores(filteredStores, "section-all", user);

  // üî• Compteur mis √† jour
  const resultsCount = document.getElementById("resultsCount");
  if (resultsCount) {
    resultsCount.textContent = `${filteredStores.length} r√©sultat${
      filteredStores.length > 1 ? "s" : ""
    }`;
  }
}

// --- Ex√©cution au chargement ---
(async () => {
  try {
    const res = await fetch("https://localhost:3000/api/users/me", {
      credentials: "include"
    });

    if (res.ok) {
      const user = await res.json();
      if (user.lat && user.lng) {
        console.log("üìç Position client :", user.lat, user.lng);
        await loadStores(user.lat, user.lng, user);
        return;
      }
    }
    console.warn("‚ö†Ô∏è Pas de coordonn√©es client ‚Üí affichage sans distance");
    await loadStores(null, null, null);
  } catch (e) {
    console.error("‚ùå Erreur r√©cup√©ration utilisateur :", e);
    await loadStores(null, null, null);
  }

})();

// --- Gestion des filtres (checkbox / radio) ---
document.addEventListener("change", (e) => {

if (e.target.matches("input[name='etat']")) {
  document.querySelectorAll("input[name='etat']").forEach(cb => {
    if (cb !== e.target) cb.checked = false; // d√©cocher les autres
  });
  applyFilters(window.currentUser);
}

  // Gestion Distance
  if (e.target.matches("input[name='distance']")) {
    document.querySelectorAll("input[name='distance']").forEach(cb => {
      if (cb !== e.target) cb.checked = false;
    });
    applyFilters(window.currentUser);
  }

  // Gestion Frais de livraison
  if (e.target.matches("input[name='delivery_fee']")) {
    document.querySelectorAll("input[name='delivery_fee']").forEach(cb => {
      if (cb !== e.target) cb.checked = false;
    });
    applyFilters(window.currentUser);
  }

  // üöÄ Gestion Tri
  if (e.target.matches("input[name='sort']")) {
    document.querySelectorAll("input[name='sort']").forEach(cb => {
      if (cb !== e.target) cb.checked = false;
    });
    applyFilters(window.currentUser);
  }
});

// --- Boutons appliquer / reset ---
const applyBtn = document.getElementById("applyFilters");
const resetBtn = document.getElementById("resetFilters");

if (applyBtn) {
  applyBtn.addEventListener("click", () => {
    filtersSidebar.classList.remove("open");
    filtersOverlay.classList.remove("active");
  });
}

if (resetBtn) {
  resetBtn.addEventListener("click", () => {
    document.querySelectorAll(
      "#filtersSidebar input[type='checkbox'], #filtersSidebar input[type='radio']"
    ).forEach(el => {
      el.checked = false;
    });
    applyFilters(window.currentUser);

    filtersSidebar.classList.remove("open");
    filtersOverlay.classList.remove("active");
  });
}
</script>

<script>
function setupCarousel(containerId) {
  const track = document.getElementById(containerId);
  if (!track) return;
   
  const carousel = track.closest(".section");
  const prevBtn = carousel.querySelector(".prev-btn");
  const nextBtn = carousel.querySelector(".next-btn");
  
  let currentIndex = 0;
  const cards = track.children;
  const visibleCards = 4;

  nextBtn.addEventListener("click", () => {
    if (currentIndex + visibleCards < cards.length) {
      currentIndex += visibleCards;
      track.style.transform = `translateX(-${currentIndex * (100 / visibleCards)}%)`;
    }
  });
  
  prevBtn.addEventListener("click", () => {
    if (currentIndex > 0) {
      currentIndex -= visibleCards;
      track.style.transform = `translateX(-${currentIndex * (100 / visibleCards)}%)`;
    }
  });
  } 
      
  
// brancher toutes les sections
["section-enseigne","section-pres","section-pop","section-rapide","section-populaires","section-all"]
  .forEach(id => setupCarousel(id));
  

  
</script>
<script>
const filtersSidebar = document.getElementById("filtersSidebar");
const filtersOverlay = document.getElementById("filtersOverlay");
const openFilters = document.getElementById("openFilters");
const closeFilters = document.getElementById("closeFilters");

if (openFilters) {
  openFilters.addEventListener("click", () => {
    filtersSidebar.classList.add("open");
    filtersOverlay.classList.add("active");
  });
}
if (closeFilters) {
  closeFilters.addEventListener("click", () => {
    filtersSidebar.classList.remove("open");
    filtersOverlay.classList.remove("active");
  });
}
if (filtersOverlay) {
  filtersOverlay.addEventListener("click", () => {
    filtersSidebar.classList.remove("open");
    filtersOverlay.classList.remove("active");
  });
}


// --- Filtre par cat√©gorie ---
document.querySelectorAll(".cat-item").forEach(item => {
  item.addEventListener("click", () => {
    const wasActive = item.classList.contains("active");

    // reset toutes les cat√©gories
    document.querySelectorAll(".cat-item").forEach(c => c.classList.remove("active"));

    if (wasActive) {
      // ‚úÖ si on reclique sur la m√™me cat√©gorie ‚Üí on enl√®ve le filtre et on recharge tout
      applyFilters(window.currentUser);
      return;
    }

    // sinon on active
    item.classList.add("active");

    const cat = item.dataset.cat; // ex: "pizza", "sushi"

let filteredStores = [...window.stores].filter(s => {
  if (!s.subcategory) return false;

  if (Array.isArray(s.subcategory)) {
    return s.subcategory.some(sc => sc.toLowerCase() === cat.toLowerCase());
  }

  return s.subcategory.toLowerCase() === cat.toLowerCase();
});

    // r√©afficher toutes les sections avec uniquement cette cat√©gorie
    renderStores(filteredStores, "section-enseigne", window.currentUser);

    if (window.currentUser?.lat && window.currentUser?.lng) {
      renderStores(
        filteredStores.filter(s => getDistanceKm(window.currentUser.lat, window.currentUser.lng, s.lat, s.lng) <= 0.5),
        "section-pres",
        window.currentUser
      );
      renderStores(
        filteredStores
          .filter(s => getDistanceKm(window.currentUser.lat, window.currentUser.lng, s.lat, s.lng) <= 1)
          .sort((a, b) => (b._count?.orders || 0) - (a._count?.orders || 0)),
        "section-pop",
        window.currentUser
      );
    }

    renderStores([...filteredStores].sort((a, b) => (a.delivery_fee || 0) - (b.delivery_fee || 0)), "section-rapide", window.currentUser);
    renderStores([...filteredStores].sort((a, b) => (b._count?.orders || 0) - (a._count?.orders || 0)), "section-populaires", window.currentUser);
    renderStores(filteredStores, "section-all", window.currentUser);

    // compteur
    const resultsCount = document.getElementById("resultsCount");
    if (resultsCount) {
      resultsCount.textContent = `${filteredStores.length} r√©sultat${filteredStores.length > 1 ? "s" : ""}`;
    }
  });
});
</script>
</main>
<footer>
  <div class="container fcols">
    <div>
      <div class="brand" style="gap:10px;margin-bottom:8px">
        <div class="brand-badge">‚ö°Ô∏è</div><b>FlashBring</b>
      </div>
      <div>Livraison locale tout-en-un.</div>
      <div class="copy">¬© <span id="y"></span>2025 FlashBring</div>
    </div>
    <div>
      <b>Entreprise</b>
<a href="index.html#about">√Ä propos</a>
<a href="index.html#careers">Carri√®res</a>
<a href="index.html#press">Presse</a>
    </div>
    <div>
      <b>L√©gal</b>
<a href="index.html#terms">CGU</a>
<a href="index.html#privacy">Confidentialit√©</a>
<a href="index.html#cookies">Cookies</a>
    </div>
    <div>
      <b>Contact</b>
<a href="index.html#support">Support</a>
<a href="index.html#drivers">Devenir livreur</a>
<a href="index.html#partners">Devenir partenaire</a>
</div>   

  </div>
</div>
    
      
<div class="footer-support">
  <div>Service client 7j/7</div>
  <div>+33 6 33 93 36 90</div>
</div>
</footer> 

<script>
const searchInput = document.getElementById("restaurantSearch");
const clearBtn = document.getElementById("clearSearch");
const suggestionsBox = document.getElementById("suggestions");

// üëâ Beautify pour corriger affichage
function beautify(word) {
  if (!word) return "";
  const corrections = {
    "telephone": "T√©l√©phone",
    "tablette": "Tablette",
    "casque": "Casque",
    "pc": "PC",
    "smartphone": "Smartphone"
  };
  const lower = word.toLowerCase();
  if (corrections[lower]) return corrections[lower];
  return lower.charAt(0).toUpperCase() + lower.slice(1);
}

if (searchInput) {
  searchInput.addEventListener("input", () => {
    const query = searchInput.value.trim();
    clearBtn.style.display = query.length > 0 ? "block" : "none";

    if (query) {
      const results = fuse.search(query);
      window.storesFiltered = results.map(r => r.item);

      // ‚ö° Pour TECH : suggestions = seulement stores + sous-cat√©gories
      const rawSuggestions = [
        ...results.map(r => ({ type: "store", value: r.item.name, banner: r.item.banner_url })),
        ...results.flatMap(r =>
          Array.isArray(r.item.subcategory)
            ? r.item.subcategory.map(sub => ({ type: "other", value: sub }))
            : [{ type: "other", value: r.item.subcategory }]
        )
      ];

      // ‚úÖ Supprimer doublons
      const uniqueSuggestions = [];
      const seen = new Set();
      for (const s of rawSuggestions) {
        const key = s.type + ":" + (s.value || "").toLowerCase();
        if (s.value && !seen.has(key)) {
          seen.add(key);
          uniqueSuggestions.push(s);
        }
      }

      // ‚úÖ Affichage suggestions
      if (uniqueSuggestions.length > 0) {
        suggestionsBox.innerHTML = uniqueSuggestions
          .slice(0, 5) // max 5 suggestions
          .map(s => {
            if (s.type === "store") {
              return `
                <div class="suggestion">
                  <img src="${s.banner}" alt="" />
                  <span>${beautify(s.value)}</span>
                </div>
              `;
            } else {
              return `
                <div class="suggestion">
                  <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <circle cx="11" cy="11" r="8" stroke-width="2"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"/>
                  </svg>
                  <span>${beautify(s.value)}</span>
                </div>
              `;
            }
          })
          .join("");
      } else {
        suggestionsBox.innerHTML = "<div>Aucun r√©sultat</div>";
      }

      // ‚úÖ clic sur une suggestion
      document.querySelectorAll("#suggestions .suggestion").forEach(div => {
        div.addEventListener("click", () => {
          searchInput.value = div.textContent.trim();
          suggestionsBox.innerHTML = "";
          const filtered = fuse.search(div.textContent.trim());
          window.storesFiltered = filtered.map(r => r.item);
          applyFilters(window.currentUser);
        });
      });
    } else {
      window.storesFiltered = null; // reset
      suggestionsBox.innerHTML = "";
    }

    applyFilters(window.currentUser);
  });

  // üëâ bouton croix
  clearBtn.addEventListener("click", () => {
    searchInput.value = "";
    clearBtn.style.display = "none";
    window.storesFiltered = null;
    suggestionsBox.innerHTML = "";
    applyFilters(window.currentUser);
  });
}
</script>
<script>
async function toggleFavorite(e, storeId) {
  e.stopPropagation(); // √©vite de d√©clencher le clic sur la carte

  const heart = e.target;
  const isActive = heart.classList.contains("active");

  try {
    if (isActive) {
      // ‚ùå Supprimer des favoris
      const res = await fetch(`https://localhost:3000/api/favorites/${storeId}`, {
        method: "DELETE",
        credentials: "include"
      });
      if (res.ok) {
        heart.classList.remove("active");
        heart.textContent = "‚ô°"; // coeur vide

        // üü¢ Mets √† jour le flag dans window.stores
        const store = window.stores.find(s => s.id === storeId);
        if (store) store.isFavorite = false;

        // üîÑ Rafra√Æchir l'affichage (y compris la section favoris)
        applyFilters(window.currentUser);
      }
    } else {
      // ‚ûï Ajouter aux favoris
      const res = await fetch(`https://localhost:3000/api/favorites/${storeId}`, {
        method: "POST",
        credentials: "include"
      });
      if (res.ok) {
        heart.classList.add("active");
        heart.textContent = "‚ô•"; // coeur plein

        // üü¢ Mets √† jour le flag dans window.stores
        const store = window.stores.find(s => s.id === storeId);
        if (store) store.isFavorite = true;

        // üîÑ Rafra√Æchir l'affichage (y compris la section favoris)
        applyFilters(window.currentUser);
      }
    }
  } catch (err) {
    console.error("Erreur favoris :", err);
  }
}

</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const infoBtn = document.getElementById("openInfo"); // bouton i
  const infoPopup = document.getElementById("infoPopup"); // popup
  const infoOverlay = document.getElementById("infoOverlay"); // overlay
  const closeInfo = document.getElementById("closeInfo"); // bouton ‚úï

  if (infoBtn && infoPopup && infoOverlay) {
    infoBtn.addEventListener("click", () => {
      infoPopup.classList.add("open");
      infoOverlay.classList.add("active");
    });
  }

  if (closeInfo) {
    closeInfo.addEventListener("click", () => {
      infoPopup.classList.remove("open");
      infoOverlay.classList.remove("active");
    });
  }

  // Fermer si on clique sur l‚Äôoverlay
  if (infoOverlay) {
    infoOverlay.addEventListener("click", () => {
      infoPopup.classList.remove("open");
      infoOverlay.classList.remove("active");
    });
  }
});
</script>
<script>
function detectDevice() {
  const ua = navigator.userAgent.toLowerCase();
  if (/iphone|ipad|ipod/.test(ua)) return "ios";
  if (/android/.test(ua)) return "android";
  if (/windows|macintosh/.test(ua)) return "pc";
  return "other";
}
</script>
<script>
async function searchQuery(query) {
  try {
    const { hits } = await index.search(query);

    if (!hits.length) {
      alert("Aucun r√©sultat trouv√©");
    }

    // üî• Log de la recherche c√¥t√© backend (toujours en HTTPS)
const response = await fetch("https://localhost:3000/api/stores/search/log", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: query,
    resultsCount: hits.length
  })
});


    const data = await response.json();
    console.log("‚úÖ Log recherche enregistr√© :", data);
    console.log("üìä R√©sultats Algolia :", hits);

  } catch (err) {
    console.error("‚ùå Erreur dans searchQuery :", err);
  }
}
</script>
</body>
</html>
